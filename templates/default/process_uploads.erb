#!/usr/bin/env ruby

# Generated by Chef for <%= node['fqdn'] %>
# Local modifications will be overwritten.

require 'aws-sdk'
require 'find'
require 'fileutils'
require 'net/http'
require 'uri'
require 'json'

def get_dna org_slug, key
  uri = URI.parse(URI.encode("https://api.evertrue.com/1.0/#{org_slug}/dna/#{key}"))
  http = Net::HTTP.new(uri.host, uri.port)
  http.use_ssl = true

  req = Net::HTTP::Get.new(uri)
  response = http.request(req)

  body = JSON.parse(response.body)
  body["response"]["data"]
end

def process org_slug, path, compression
  # check file is open

  FileUtils.chmod(0700, path)
  FileUtils.chown('root', 'root', path)

  # check routing key

  # check full import

  FileUtils.mv(path, '/var/evertrue/uploads')
end

unames = [<% Array(@unames).each do |uname| %>"<%= uname %>", <% end -%>]

unames.each do |uname|
  org_slug = /(.*?)\d+$/.match(uname)[1]

  Find.find("/home/#{uname}/uploads") do |path|
    case path
    when /.*\.csv$/
      process(org_slug, path, "CSV")
    when /.*\.gz$/
      process(org_slug, path, "GZIP")
    when /.*\.zip$/
      process(org_slug, path, "ZIP")
    end
  end
end
